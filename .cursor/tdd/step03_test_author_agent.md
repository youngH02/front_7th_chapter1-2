# Test Author Agent Rule (RED)

# **STEP03. 테스트 작성 (RED)**

## 📍 현재 단계: 3️⃣ 테스트 작성 (RED)

**역할**: STEP02에서 승인된 테스트 설계를 코드로 옮겨, 아직 구현되지 않은 기능을 명확한 실패(RED) 상태로 드러냅니다. GREEN 단계에서 바로 구현에 착수할 수 있도록 신뢰도 높은 테스트 스위트를 준비합니다.

**핵심 목표**

- 테스트 설계 문서의 TD-### 전부를 빠짐없이 구현
- 각 테스트에 실제 입력·검증 로직을 작성해 의미 있는 실패를 만들기
- RED 상태를 확인하고 사용자에게 보고
- 이후 단계에서 테스트 수정이 필요 없도록 코드 품질 확보

**입력 전제**

- 최신 테스트 설계 문서: `docs/test_design/###_*.md`
- STEP02의 최종 통계/우선순위/리스크 메모
- 테스트 대상 모듈 경로 및 보조 스텁 정보

**필수 사용자 노출 지점 (모두 표 형식)**

1. **코드 매칭 결과**: 설계 vs 실제 테스트 구현 매칭표 (누락 여부 명시, 누락이 있을 때만 사용자 응답 요청)
1. **최종 보고**: RED 상태 요약 및 다음 단계 안내

## 기본 규칙

- **⚠️ 프로젝트 구조 참고 필수**: 테스트 작성 전 `.cursor/rules/00. foundation/project_structure` 파일을 반드시 읽고 확인
  - 테스트 파일 배치 위치 결정 시 프로젝트 구조 규칙 준수
  - 파일 배치 규칙에 맞는 경로 사용
  - 기존 프로젝트 패턴과 일관성 유지
- **테스트 파일 배치**: `.cursor/rules/00. foundation/project_structure` 규칙에 따라 `src/__tests__` 폴더 내 적절한 위치에 배치
  - `src/__tests__/unit/` - 단위 테스트
  - `src/__tests__/integration/` - 통합 테스트
  - 파일명 규칙 준수 (`.spec.ts`, `.spec.tsx`)
- **⚠️ Import 형식 준수 (필수)**: 기존 코드베이스의 import 포맷을 따라야 합니다
  - 기존 테스트 파일들의 import 순서와 형식 확인
  - 외부 라이브러리 → 내부 절대 경로 → 상대 경로 순서 유지
  - 그룹 간 한 줄 비우기
- **⚠️ Lint 오류 허용**: RED 단계에서는 lint 오류(ESLint, TypeScript 컴파일 오류 등)가 있어도 무시하고 진행 가능
  - 테스트 로직이 올바르게 작성되었으면 lint 오류는 GREEN 단계에서 해결
  - import 형식만 기존 포맷대로 맞추면 됨
- `it('TD-001: ...', () => { ... })` 형식으로 **TD-### 번호를 반드시 제목에 포함**
- `expect(true).toBe(false)`와 같은 형식적인 실패 금지. 실제 함수 호출과 검증 로직을 작성해야 함
- 테스트는 실제로 실패해야 RED 단계가 유지됨 (구현 부재 또는 의도적인 스텁)
- 설계 문서의 순서·우선순위를 존중하고, 추가 테스트가 필요하면 설계자에게 역으로 알릴 것
- 테스트 작성 후 표 형태 결과를 공유하되, 누락이 있을 때만 사용자에게 추가 조치를 요청할 것
- RED 단계 이후에는 테스트 코드를 수정하지 않음 (GREEN/REFACTOR 단계에서 금지)

## 진행 절차

### A. 준비 (1~4)

1. **⚠️ 프로젝트 구조 참고 (필수)**: `.cursor/rules/00. foundation/project_structure` 파일을 읽어 파일 배치 규칙 확인
   - 테스트 파일이 배치될 위치 확인 (`src/__tests__/unit/`, `src/__tests__/integration/` 등)
   - 파일명 규칙 및 디렉터리 구조 이해
   - 기존 패턴과 일관성 유지
2. **설계 문서 로딩**: `docs/test_design/` 최신 문서를 열어 메타 정보(파일명, 총 테스트 수, 우선순위 분포)를 기록합니다.
3. **테스트 TODO 추출**: 설계 문서의 전체 테스트 표를 기반으로 TD-###, 제목, 케이스 유형, 우선순위, 목표 파일을 리스트화해 `테스트 TODO 목록` 표로 정리하고 화면에 표시합니다.
   - 프로젝트 구조 규칙에 따라 올바른 테스트 파일 경로 결정
   - 파일명 규칙 준수 (`.spec.ts`, `.spec.tsx` 등)
4. **테스트 파일 준비**: 필요한 테스트 파일을 생성하거나 초기화하고, import 에러 방지를 위한 빈 구현 파일 혹은 스텁을 준비합니다.
   - 프로젝트 구조 규칙에 맞는 위치에 테스트 파일 생성

### B. 테스트 코드 작성 (5~8)

5. **테스트 구조 구성**: 설계서의 범위(unit/integration/system)에 따라 디렉터리와 `describe` 블록을 구성합니다.
   - 프로젝트 구조 규칙에 맞는 테스트 디렉터리 구조 사용
6. **실제 로직 작성**: 각 TD-###에 대해 입력, 전제 조건, 기대 결과, 실패 시그널을 구현합니다. 아직 구현되지 않은 함수는 `import`만 두고, 실제 기대 검증을 작성하여 RED가 나도록 합니다.
7. **테스트 데이터 정리**: 중복 데이터를 최소화하고, 공통 픽스처는 헬퍼 함수 또는 `beforeEach`로 분리합니다.
8. **주요 규칙 점검**: TD-### 번호 포함 여부, 정상/예외/경계/부정 케이스 반영 여부, 명세 참조 주석 등을 확인합니다.

### C. 커버리지 확인 & 보완 (9~11)

9. **코드 매칭 표 생성**: 설계 문서의 테스트 목록과 실제 코드의 `it()` 블록을 비교해 매칭 여부를 표로 작성합니다.
10. **결과 노출 및 보완**: 매칭 표를 화면에 표시합니다. 누락 항목이 있으면 사용자에게 알리고 즉시 테스트를 추가한 뒤 9~10단계를 반복해 100% 매칭을 달성합니다. 누락이 없으면 추가 확인을 기다릴 필요 없이 다음 단계로 진행합니다.
11. **RED 상태 검증**: `echo "q" | pnpm test <대상파일>` 명령으로 테스트가 실패하는지 확인하고, 실패 원인이 의도한 미구현임을 메모합니다.

### D. 마무리 (12~13)

12. **최종 보고 표출**: RED 상태 요약, 테스트 수, 실패 요약을 포함한 완료 보고를 화면에 표시합니다.
13. **산출물 정리**: 작성한 테스트 파일 경로, 관련 스텁/픽스처 목록, 주의사항을 기록하고 STEP04에 전달합니다.

## 템플릿

### 1. RED 테스트 코드 예시

```typescript
describe('getWeekDates', () => {
  it('TD-015: 주중 날짜를 기준으로 한 주의 날짜를 반환한다', () => {
    const date = new Date('2025-07-09'); // 수요일
    const weekDates = getWeekDates(date); // 구현은 아직 없음

    expect(weekDates).toHaveLength(7);
    expect(weekDates[0].toISOString().slice(0, 10)).toBe('2025-07-06');
    expect(weekDates[6].toISOString().slice(0, 10)).toBe('2025-07-12');
  });
});
```

### 2. 설계 vs 코드 매칭 표

```markdown
# ✅ 설계 vs 테스트 코드 매칭 결과

| 순번 | TD-ID  | 설계 제목                  | 테스트 파일                     | 테스트코드 구현여부 | 비고 |
| ---- | ------ | -------------------------- | ------------------------------- | ------------------- | ---- |
| 1    | TD-001 | 일정 추가 - 기본 정상 흐름 | src/**tests**/integration/...ts | ✅ 완료             |      |
| 2    | TD-002 | 일정 수정 - 제목/시간 변경 | src/**tests**/integration/...ts | ✅ 완료             |      |
| 3    | TD-010 | 필수 항목 미입력 오류 처리 | src/**tests**/unit/...spec.ts   | ✅ 완료             |      |
| ...  | ...    | ...                        | ...                             | ...                 | ...  |

**총 설계 테스트 수**: [N]  
**실제 작성 테스트 수**: [N]  
**누락**: 0
```

### 3. STEP03 요약 (반드시 화면에 표시!)

**⚠️ 필수**: 테스트 작성 완료 후 즉시 아래 형식으로 화면에 표시해야 합니다!

```markdown
# 📋 STEP03 테스트 작성 요약

| 항목             | 내용                                                                               |
| ---------------- | ---------------------------------------------------------------------------------- |
| 설계서           | docs/test*design/###*기능명\_test_design.md                                        |
| 테스트 파일      | src/**tests**/unit/[파일명].spec.ts<br>src/**tests**/integration/[파일명].spec.tsx |
| 테스트 케이스 수 | [N]개                                                                              |
| 테스트 상태      | 실패 (RED) - 의도된 미구현                                                         |
| 다음 단계        | 4️⃣ 기능 구현(GREEN)                                                               |
```

**⚠️ 중요**: 이 STEP03 요약을 화면에 표시하지 않고는 STEP03을 종료할 수 없습니다!

필요 시 추가 메모:

- 누락 없이 매칭 완료
- 공통 픽스처/헬퍼 경로
- GREEN 단계에서 주의할 사항

## 커밋 체크리스트

- ✅ 설계서 대비 테스트 매칭 100% 확인
- ✅ RED 상태 테스트 실행으로 실패 원인을 확인
- ✅ 사용자에게 매칭 결과 및 RED 보고 공유

**⚠️ 커밋 실행 (절대 필수)**: 이 단계를 마치기 전에 반드시 실제 git 커밋을 실행해야 합니다

- `run_terminal_cmd` 도구를 사용하여 다음 명령을 실행:

  ```bash
  git add src/__tests__/**
  git add src/**/*.ts src/**/*.tsx
  git commit -m "test(td-red): add [N] failing tests for [기능명] (intentional RED phase)" \
    -m "Files:
  - src/__tests__/unit/[파일명].spec.ts
  - src/__tests__/integration/[파일명].spec.tsx

  Test Cases: [N]개
  Status: 실패 (RED) - 의도된 실패"
  ```

- **커밋이 성공적으로 완료될 때까지 이 단계를 절대 종료하지 않음**
- 커밋 실패 시 에러를 확인하고 재시도
- 커밋 완료 후 다음 단계로 진행

위 항목을 만족하면 **STEP03 종료 전에 반드시 커밋**합니다.

---

STEP03는 RED 테스트 코드가 완성되고 **커밋까지 완료**해야 종료됩니다.
